<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LLVM: lib/Transforms/Utils/MisExpect.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">LLVM
   &#160;<span id="projectnumber">17.0.0git</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */</script>
<div id="main-nav"></div>
<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_97aefd0d527b934f1d99a682da8fe6a9.html">lib</a></li><li class="navelem"><a class="el" href="dir_a72932e0778af28115095468f6286ff8.html">Transforms</a></li><li class="navelem"><a class="el" href="dir_f75c00afeb315f44d76556a7c675e6e8.html">Utils</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">MisExpect.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="MisExpect_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">//===--- MisExpect.cpp - Check the use of llvm.expect with PGO data -------===//</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">// Part of the LLVM Project, under the Apache License v2.0 with LLVM Exceptions.</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// See https://llvm.org/LICENSE.txt for license information.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">// SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">//===----------------------------------------------------------------------===//</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// This contains code to emit warnings for potentially incorrect usage of the</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// llvm.expect intrinsic. This utility extracts the threshold values from</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// metadata associated with the instrumented Branch or Switch instruction. The</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">// threshold values are then used to determine if a warning should be emmited.</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">// MisExpect&#39;s implementation relies on two assumptions about how branch weights</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">// are managed in LLVM.</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">// 1) Frontend profiling weights are always in place before llvm.expect is</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">// lowered in LowerExpectIntrinsic.cpp. Frontend based instrumentation therefore</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">// needs to extract the branch weights and then compare them to the weights</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">// being added by the llvm.expect intrinsic lowering.</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">// 2) Sampling and IR based profiles will *only* have branch weight metadata</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">// before profiling data is consulted if they are from a lowered llvm.expect</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">// intrinsic. These profiles thus always extract the expected weights and then</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">// compare them to the weights collected during profiling to determine if a</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">// diagnostic message is warranted.</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">//===----------------------------------------------------------------------===//</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160; </div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="MisExpect_8h.html">llvm/Transforms/Utils/MisExpect.h</a>&quot;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="Twine_8h.html">llvm/ADT/Twine.h</a>&quot;</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="OptimizationRemarkEmitter_8h.html">llvm/Analysis/OptimizationRemarkEmitter.h</a>&quot;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="Constants_8h.html">llvm/IR/Constants.h</a>&quot;</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="DiagnosticInfo_8h.html">llvm/IR/DiagnosticInfo.h</a>&quot;</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="IR_2Instruction_8h.html">llvm/IR/Instruction.h</a>&quot;</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="Instructions_8h.html">llvm/IR/Instructions.h</a>&quot;</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="LLVMContext_8h.html">llvm/IR/LLVMContext.h</a>&quot;</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="ProfDataUtils_8h.html">llvm/IR/ProfDataUtils.h</a>&quot;</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="BranchProbability_8h.html">llvm/Support/BranchProbability.h</a>&quot;</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="CommandLine_8h.html">llvm/Support/CommandLine.h</a>&quot;</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="Debug_8h.html">llvm/Support/Debug.h</a>&quot;</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="FormatVariadic_8h.html">llvm/Support/FormatVariadic.h</a>&quot;</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &lt;cstdint&gt;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#include &lt;functional&gt;</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &lt;numeric&gt;</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160; </div>
<div class="line"><a name="l00048"></a><span class="lineno"><a class="line" href="MisExpect_8cpp.html#ad78e062f62e0d6e453941fb4ca843e4d">   48</a></span>&#160;<span class="preprocessor">#define DEBUG_TYPE &quot;misexpect&quot;</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160; </div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="keyword">using namespace </span><a class="code" href="namespacellvm.html">llvm</a>;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="keyword">using namespace </span>misexpect;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160; </div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacellvm.html">llvm</a> {</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160; </div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment">// Command line option to enable/disable the warning when profile data suggests</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment">// a mismatch with the use of the llvm.expect intrinsic</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="keyword">static</span> <a class="code" href="classllvm_1_1cl_1_1opt.html">cl::opt&lt;bool&gt;</a> <a class="code" href="namespacellvm.html#a398a9aa98927dce08c1aebcfdfedaa6f">PGOWarnMisExpect</a>(</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="stringliteral">&quot;pgo-warn-misexpect&quot;</span>, <a class="code" href="namespacellvm_1_1cl.html#a10a041239ae1870cfcc064bfaa79fb65">cl::init</a>(<span class="keyword">false</span>), <a class="code" href="namespacellvm_1_1cl.html#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">cl::Hidden</a>,</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <a class="code" href="structllvm_1_1cl_1_1desc.html">cl::desc</a>(<span class="stringliteral">&quot;Use this option to turn on/off &quot;</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;             <span class="stringliteral">&quot;warnings about incorrect usage of llvm.expect intrinsics.&quot;</span>));</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160; </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="keyword">static</span> <a class="code" href="classllvm_1_1cl_1_1opt.html">cl::opt&lt;uint32_t&gt;</a> <a class="code" href="namespacellvm.html#a0883663b1b2d8338f034f514cf8274d7">MisExpectTolerance</a>(</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="stringliteral">&quot;misexpect-tolerance&quot;</span>, <a class="code" href="namespacellvm_1_1cl.html#a10a041239ae1870cfcc064bfaa79fb65">cl::init</a>(0),</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <a class="code" href="structllvm_1_1cl_1_1desc.html">cl::desc</a>(<span class="stringliteral">&quot;Prevents emiting diagnostics when profile counts are &quot;</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;             <span class="stringliteral">&quot;within N% of the threshold..&quot;</span>));</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160; </div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;} <span class="comment">// namespace llvm</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160; </div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="keyword">namespace </span>{</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160; </div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="keywordtype">bool</span> isMisExpectDiagEnabled(<a class="code" href="classllvm_1_1LLVMContext.html">LLVMContext</a> &amp;Ctx) {</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="namespacellvm.html#a398a9aa98927dce08c1aebcfdfedaa6f">PGOWarnMisExpect</a> || Ctx.<a class="code" href="classllvm_1_1LLVMContext.html#a53a8308662fa241f81a8bd424f6ce5ee">getMisExpectWarningRequested</a>();</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;}</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160; </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<a class="code" href="classuint32__t.html">uint32_t</a> getMisExpectTolerance(<a class="code" href="classllvm_1_1LLVMContext.html">LLVMContext</a> &amp;Ctx) {</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="namespacellvm.html#ab4d4bc901fedd8857f647dcc2c0d71de">std::max</a>(<span class="keyword">static_cast&lt;</span><a class="code" href="classuint32__t.html">uint32_t</a><span class="keyword">&gt;</span>(<a class="code" href="namespacellvm.html#a0883663b1b2d8338f034f514cf8274d7">MisExpectTolerance</a>),</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;                  Ctx.<a class="code" href="classllvm_1_1LLVMContext.html#afe71303f670173ad9ac988daddda59dc">getDiagnosticsMisExpectTolerance</a>());</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;}</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160; </div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<a class="code" href="classllvm_1_1Instruction.html">Instruction</a> *getInstCondition(<a class="code" href="classllvm_1_1Instruction.html">Instruction</a> *<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>) {</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  <a class="code" href="SILowerControlFlow_8cpp.html#a4868c5d81c5ccc98c47aeab6244346a0">assert</a>(<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a> != <span class="keyword">nullptr</span> &amp;&amp; <span class="stringliteral">&quot;MisExpect target Instruction cannot be nullptr&quot;</span>);</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  <a class="code" href="classllvm_1_1Instruction.html">Instruction</a> *<a class="code" href="namespacellvm_1_1MipsISD.html#a422daf9aa810935178671306b651d69ba366e1eac31eeb1a1892d62ccfc0c8cf8">Ret</a> = <span class="keyword">nullptr</span>;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="keywordflow">if</span> (<span class="keyword">auto</span> *<a class="code" href="BuiltinGCs_8cpp.html#a7abf5fb4071cb25dbce06dfb5ee3c937">B</a> = dyn_cast&lt;BranchInst&gt;(<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) {</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <a class="code" href="namespacellvm_1_1MipsISD.html#a422daf9aa810935178671306b651d69ba366e1eac31eeb1a1892d62ccfc0c8cf8">Ret</a> = dyn_cast&lt;Instruction&gt;(<a class="code" href="BuiltinGCs_8cpp.html#a7abf5fb4071cb25dbce06dfb5ee3c937">B</a>-&gt;getCondition());</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  }</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="comment">// TODO: Find a way to resolve condition location for switches</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="comment">// Using the condition of the switch seems to often resolve to an earlier</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="comment">// point in the program, i.e. the calculation of the switch condition, rather</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <span class="comment">// than the switch&#39;s location in the source code. Thus, we should use the</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <span class="comment">// instruction to get source code locations rather than the condition to</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <span class="comment">// improve diagnostic output, such as the caret. If the same problem exists</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="comment">// for branch instructions, then we should remove this function and directly</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="comment">// use the instruction</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> *<a class="code" href="lib_2Target_2ARM_2README_8txt.html#a1b45f45820a60c09244a87eb59824aec">S</a> = dyn_cast&lt;SwitchInst&gt;(<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>)) {</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;    <a class="code" href="namespacellvm_1_1MipsISD.html#a422daf9aa810935178671306b651d69ba366e1eac31eeb1a1892d62ccfc0c8cf8">Ret</a> = dyn_cast&lt;Instruction&gt;(<a class="code" href="lib_2Target_2ARM_2README_8txt.html#a1b45f45820a60c09244a87eb59824aec">S</a>-&gt;getCondition());</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  }</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;  <span class="keywordflow">return</span> <a class="code" href="namespacellvm_1_1MipsISD.html#a422daf9aa810935178671306b651d69ba366e1eac31eeb1a1892d62ccfc0c8cf8">Ret</a> ? <a class="code" href="namespacellvm_1_1MipsISD.html#a422daf9aa810935178671306b651d69ba366e1eac31eeb1a1892d62ccfc0c8cf8">Ret</a> : <a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;}</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160; </div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="keywordtype">void</span> emitMisexpectDiagnostic(<a class="code" href="classllvm_1_1Instruction.html">Instruction</a> *<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <a class="code" href="classllvm_1_1LLVMContext.html">LLVMContext</a> &amp;Ctx,</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;                             <a class="code" href="ADT_2tmp_8txt.html#a07ed0bfaa124c15897944fe3eaa971ab">uint64_t</a> ProfCount, <a class="code" href="ADT_2tmp_8txt.html#a07ed0bfaa124c15897944fe3eaa971ab">uint64_t</a> TotalCount) {</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  <span class="keywordtype">double</span> PercentageCorrect = (<a class="code" href="README-SSE_8txt.html#a698e4bd87a8adc0c042ae6b6e10ee6e1">double</a>)ProfCount / TotalCount;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <span class="keyword">auto</span> PerString =</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;      <a class="code" href="namespacellvm.html#a07eb6e84b522073e52d92dccf5015c01">formatv</a>(<span class="stringliteral">&quot;{0:P} ({1} / {2})&quot;</span>, PercentageCorrect, ProfCount, TotalCount);</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  <span class="keyword">auto</span> RemStr = <a class="code" href="namespacellvm.html#a07eb6e84b522073e52d92dccf5015c01">formatv</a>(</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;      <span class="stringliteral">&quot;Potential performance regression from use of the llvm.expect intrinsic: &quot;</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;      <span class="stringliteral">&quot;Annotation was correct on {0} of profiled executions.&quot;</span>,</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;      PerString);</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  <a class="code" href="classllvm_1_1Twine.html">Twine</a> <a class="code" href="namespacellvm_1_1AMDGPU_1_1SendMsg.html#ad7fab8522e49be1b20c4db4fc431bd3c">Msg</a>(PerString);</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  <a class="code" href="classllvm_1_1Instruction.html">Instruction</a> *<a class="code" href="BasicBlockSections_8cpp.html#a5fd0741d696f28faf65b33f6c6af8fda">Cond</a> = getInstCondition(<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>);</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;  <span class="keywordflow">if</span> (isMisExpectDiagEnabled(Ctx))</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    Ctx.<a class="code" href="classllvm_1_1LLVMContext.html#aad03ef5cfbe6e7cad076d9e45ba06592">diagnose</a>(<a class="code" href="classllvm_1_1DiagnosticInfoMisExpect.html">DiagnosticInfoMisExpect</a>(<a class="code" href="BasicBlockSections_8cpp.html#a5fd0741d696f28faf65b33f6c6af8fda">Cond</a>, <a class="code" href="namespacellvm_1_1AMDGPU_1_1SendMsg.html#ad7fab8522e49be1b20c4db4fc431bd3c">Msg</a>));</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  <a class="code" href="classllvm_1_1OptimizationRemarkEmitter.html">OptimizationRemarkEmitter</a> ORE(<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>-&gt;getParent()-&gt;getParent());</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  ORE.emit(<a class="code" href="classllvm_1_1OptimizationRemark.html">OptimizationRemark</a>(<a class="code" href="MisExpect_8cpp.html#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG_TYPE</a>, <span class="stringliteral">&quot;misexpect&quot;</span>, <a class="code" href="BasicBlockSections_8cpp.html#a5fd0741d696f28faf65b33f6c6af8fda">Cond</a>) &lt;&lt; RemStr.str());</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;}</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160; </div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;} <span class="comment">// namespace</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160; </div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;<span class="keyword">namespace </span><a class="code" href="namespacellvm.html">llvm</a> {</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="keyword">namespace </span>misexpect {</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160; </div>
<div class="line"><a name="l00123"></a><span class="lineno"><a class="line" href="namespacellvm_1_1misexpect.html#a8677c5d2618fcf52eda43f5530decb6b">  123</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacellvm_1_1misexpect.html#a8677c5d2618fcf52eda43f5530decb6b">verifyMisExpect</a>(<a class="code" href="classllvm_1_1Instruction.html">Instruction</a> &amp;<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <a class="code" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;uint32_t&gt;</a> RealWeights,</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;                     <a class="code" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;uint32_t&gt;</a> ExpectedWeights) {</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;  <span class="comment">// To determine if we emit a diagnostic, we need to compare the branch weights</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;  <span class="comment">// from the profile to those added by the llvm.expect intrinsic.</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  <span class="comment">// So first, we extract the &quot;likely&quot; and &quot;unlikely&quot; weights from</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  <span class="comment">// ExpectedWeights And determine the correct weight in the profile to compare</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  <span class="comment">// against.</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  <a class="code" href="ADT_2tmp_8txt.html#a07ed0bfaa124c15897944fe3eaa971ab">uint64_t</a> <a class="code" href="LowerExpectIntrinsic_8cpp.html#ad49597ea9df30b48ee0bae5eae846648">LikelyBranchWeight</a> = 0,</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;           <a class="code" href="LowerExpectIntrinsic_8cpp.html#a6d8dd0fde9d96e02f04db1523ab644df">UnlikelyBranchWeight</a> = <a class="code" href="namespacellvm.html#ab4d4bc901fedd8857f647dcc2c0d71de">std::numeric_limits&lt;uint32_t&gt;::max</a>();</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  <span class="keywordtype">size_t</span> MaxIndex = 0;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> Idx = 0, End = ExpectedWeights.<a class="code" href="classllvm_1_1ArrayRef.html#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>(); Idx &lt; End; Idx++) {</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    <a class="code" href="classuint32__t.html">uint32_t</a> V = ExpectedWeights[Idx];</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="LowerExpectIntrinsic_8cpp.html#ad49597ea9df30b48ee0bae5eae846648">LikelyBranchWeight</a> &lt; V) {</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;      <a class="code" href="LowerExpectIntrinsic_8cpp.html#ad49597ea9df30b48ee0bae5eae846648">LikelyBranchWeight</a> = V;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;      MaxIndex = Idx;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;    }</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="LowerExpectIntrinsic_8cpp.html#a6d8dd0fde9d96e02f04db1523ab644df">UnlikelyBranchWeight</a> &gt; V) {</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;      <a class="code" href="LowerExpectIntrinsic_8cpp.html#a6d8dd0fde9d96e02f04db1523ab644df">UnlikelyBranchWeight</a> = V;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;    }</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  }</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160; </div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  <span class="keyword">const</span> <a class="code" href="ADT_2tmp_8txt.html#a07ed0bfaa124c15897944fe3eaa971ab">uint64_t</a> ProfiledWeight = RealWeights[MaxIndex];</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  <span class="keyword">const</span> <a class="code" href="ADT_2tmp_8txt.html#a07ed0bfaa124c15897944fe3eaa971ab">uint64_t</a> RealWeightsTotal =</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;      std::accumulate(RealWeights.<a class="code" href="classllvm_1_1ArrayRef.html#aab36927882fbfdcbb860d87fd9c30da8">begin</a>(), RealWeights.<a class="code" href="classllvm_1_1ArrayRef.html#a7ca5197533a9c1fb8a2bd30587fcec6b">end</a>(), (<a class="code" href="ADT_2tmp_8txt.html#a07ed0bfaa124c15897944fe3eaa971ab">uint64_t</a>)0,</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;                      std::plus&lt;uint64_t&gt;());</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  <span class="keyword">const</span> <a class="code" href="ADT_2tmp_8txt.html#a07ed0bfaa124c15897944fe3eaa971ab">uint64_t</a> NumUnlikelyTargets = RealWeights.<a class="code" href="classllvm_1_1ArrayRef.html#a85ffb6531d4cda988ea81f18d4e56fb7">size</a>() - 1;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160; </div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  <a class="code" href="ADT_2tmp_8txt.html#a07ed0bfaa124c15897944fe3eaa971ab">uint64_t</a> TotalBranchWeight =</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;      <a class="code" href="LowerExpectIntrinsic_8cpp.html#ad49597ea9df30b48ee0bae5eae846648">LikelyBranchWeight</a> + (<a class="code" href="LowerExpectIntrinsic_8cpp.html#a6d8dd0fde9d96e02f04db1523ab644df">UnlikelyBranchWeight</a> * NumUnlikelyTargets);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160; </div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="comment">// FIXME: When we&#39;ve addressed sample profiling, restore the assertion</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  <span class="comment">//</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;  <span class="comment">// We cannot calculate branch probability if either of these invariants aren&#39;t</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;  <span class="comment">// met. However, MisExpect diagnostics should not prevent code from compiling,</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  <span class="comment">// so we simply forgo emitting diagnostics here, and return early.</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;  <span class="comment">// assert((TotalBranchWeight &gt;= LikelyBranchWeight) &amp;&amp; (TotalBranchWeight &gt; 0)</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  <span class="comment">//              &amp;&amp; &quot;TotalBranchWeight is less than the Likely branch weight&quot;);</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;  <span class="keywordflow">if</span> ((TotalBranchWeight == 0) || (TotalBranchWeight &lt;= <a class="code" href="LowerExpectIntrinsic_8cpp.html#ad49597ea9df30b48ee0bae5eae846648">LikelyBranchWeight</a>))</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160; </div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  <span class="comment">// To determine our threshold value we need to obtain the branch probability</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;  <span class="comment">// for the weights added by llvm.expect and use that proportion to calculate</span></div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  <span class="comment">// our threshold based on the collected profile data.</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;  <span class="keyword">auto</span> LikelyProbablilty = <a class="code" href="classllvm_1_1BranchProbability.html#a0333345669e75a54c7de3d5fe0f6e746">BranchProbability::getBranchProbability</a>(</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;      <a class="code" href="LowerExpectIntrinsic_8cpp.html#ad49597ea9df30b48ee0bae5eae846648">LikelyBranchWeight</a>, TotalBranchWeight);</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160; </div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  <a class="code" href="ADT_2tmp_8txt.html#a07ed0bfaa124c15897944fe3eaa971ab">uint64_t</a> ScaledThreshold = LikelyProbablilty.scale(RealWeightsTotal);</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160; </div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  <span class="comment">// clamp tolerance range to [0, 100)</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  <span class="keyword">auto</span> Tolerance = getMisExpectTolerance(<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getContext());</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;  Tolerance = std::clamp(Tolerance, 0u, 99u);</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160; </div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  <span class="comment">// Allow users to relax checking by N%  i.e., if they use a 5% tolerance,</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  <span class="comment">// then we check against 0.95*ScaledThreshold</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  <span class="keywordflow">if</span> (Tolerance &gt; 0)</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    ScaledThreshold *= (1.0 - Tolerance / 100.0);</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160; </div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;  <span class="comment">// When the profile weight is below the threshold, we emit the diagnostic</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  <span class="keywordflow">if</span> (ProfiledWeight &lt; ScaledThreshold)</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    emitMisexpectDiagnostic(&amp;<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, <a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>.getContext(), ProfiledWeight,</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;                            RealWeightsTotal);</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;}</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160; </div>
<div class="line"><a name="l00186"></a><span class="lineno"><a class="line" href="namespacellvm_1_1misexpect.html#a62ecd68a608ec120263975c279ae3dab">  186</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacellvm_1_1misexpect.html#a62ecd68a608ec120263975c279ae3dab">checkBackendInstrumentation</a>(<a class="code" href="classllvm_1_1Instruction.html">Instruction</a> &amp;<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>,</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;                                 <span class="keyword">const</span> <a class="code" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;uint32_t&gt;</a> RealWeights) {</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;  <a class="code" href="classllvm_1_1SmallVector.html">SmallVector&lt;uint32_t&gt;</a> ExpectedWeights;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="namespacellvm.html#ac19cbbc4935a23e1d44f65e1eaba6b1d">extractBranchWeights</a>(<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, ExpectedWeights))</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  <a class="code" href="namespacellvm_1_1misexpect.html#a8677c5d2618fcf52eda43f5530decb6b">verifyMisExpect</a>(<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, RealWeights, ExpectedWeights);</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;}</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160; </div>
<div class="line"><a name="l00194"></a><span class="lineno"><a class="line" href="namespacellvm_1_1misexpect.html#a21de4796e674d8dabcea69242abe5005">  194</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacellvm_1_1misexpect.html#a21de4796e674d8dabcea69242abe5005">checkFrontendInstrumentation</a>(<a class="code" href="classllvm_1_1Instruction.html">Instruction</a> &amp;<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>,</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;                                  <span class="keyword">const</span> <a class="code" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;uint32_t&gt;</a> ExpectedWeights) {</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  <a class="code" href="classllvm_1_1SmallVector.html">SmallVector&lt;uint32_t&gt;</a> RealWeights;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  <span class="keywordflow">if</span> (!<a class="code" href="namespacellvm.html#ac19cbbc4935a23e1d44f65e1eaba6b1d">extractBranchWeights</a>(<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, RealWeights))</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;  <a class="code" href="namespacellvm_1_1misexpect.html#a8677c5d2618fcf52eda43f5530decb6b">verifyMisExpect</a>(<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, RealWeights, ExpectedWeights);</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;}</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160; </div>
<div class="line"><a name="l00202"></a><span class="lineno"><a class="line" href="namespacellvm_1_1misexpect.html#a4c52059f91406714507309d168ff95b8">  202</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="namespacellvm_1_1misexpect.html#a4c52059f91406714507309d168ff95b8">checkExpectAnnotations</a>(<a class="code" href="classllvm_1_1Instruction.html">Instruction</a> &amp;<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>,</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;                            <span class="keyword">const</span> <a class="code" href="classllvm_1_1ArrayRef.html">ArrayRef&lt;uint32_t&gt;</a> ExistingWeights,</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;                            <span class="keywordtype">bool</span> IsFrontend) {</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  <span class="keywordflow">if</span> (IsFrontend) {</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <a class="code" href="namespacellvm_1_1misexpect.html#a21de4796e674d8dabcea69242abe5005">checkFrontendInstrumentation</a>(<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, ExistingWeights);</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;  } <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    <a class="code" href="namespacellvm_1_1misexpect.html#a62ecd68a608ec120263975c279ae3dab">checkBackendInstrumentation</a>(<a class="code" href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a>, ExistingWeights);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  }</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;}</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160; </div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;} <span class="comment">// namespace misexpect</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;} <span class="comment">// namespace llvm</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="preprocessor">#undef DEBUG_TYPE</span></div>
</div><!-- fragment --></div><!-- contents -->
<div class="ttc" id="anamespacellvm_1_1misexpect_html_a21de4796e674d8dabcea69242abe5005"><div class="ttname"><a href="namespacellvm_1_1misexpect.html#a21de4796e674d8dabcea69242abe5005">llvm::misexpect::checkFrontendInstrumentation</a></div><div class="ttdeci">void checkFrontendInstrumentation(Instruction &amp;I, const ArrayRef&lt; uint32_t &gt; ExpectedWeights)</div><div class="ttdoc">checkFrontendInstrumentation - compares PGO counters to the thresholds used for llvm....</div><div class="ttdef"><b>Definition:</b> <a href="MisExpect_8cpp_source.html#l00194">MisExpect.cpp:194</a></div></div>
<div class="ttc" id="anamespacellvm_html"><div class="ttname"><a href="namespacellvm.html">llvm</a></div><div class="ttdoc">This is an optimization pass for GlobalISel generic memory operations.</div><div class="ttdef"><b>Definition:</b> <a href="AddressRanges_8h_source.html#l00018">AddressRanges.h:18</a></div></div>
<div class="ttc" id="aclassllvm_1_1LLVMContext_html_a53a8308662fa241f81a8bd424f6ce5ee"><div class="ttname"><a href="classllvm_1_1LLVMContext.html#a53a8308662fa241f81a8bd424f6ce5ee">llvm::LLVMContext::getMisExpectWarningRequested</a></div><div class="ttdeci">bool getMisExpectWarningRequested() const</div><div class="ttdef"><b>Definition:</b> <a href="LLVMContext_8cpp_source.html#l00149">LLVMContext.cpp:149</a></div></div>
<div class="ttc" id="aREADME-SSE_8txt_html_a698e4bd87a8adc0c042ae6b6e10ee6e1"><div class="ttname"><a href="README-SSE_8txt.html#a698e4bd87a8adc0c042ae6b6e10ee6e1">double</a></div><div class="ttdeci">into xmm2 addss xmm2 xmm1 xmm3 addss xmm3 movaps xmm0 unpcklps xmm0 ret seems silly when it could just be one addps Expand libm rounding functions main should enable SSE DAZ mode and other fast SSE modes Think about doing i64 math in SSE regs on x86 This testcase should have no SSE instructions in and only one load from a constant double</div><div class="ttdef"><b>Definition:</b> <a href="README-SSE_8txt_source.html#l00085">README-SSE.txt:85</a></div></div>
<div class="ttc" id="aclassllvm_1_1SmallVector_html"><div class="ttname"><a href="classllvm_1_1SmallVector.html">llvm::SmallVector&lt; uint32_t &gt;</a></div></div>
<div class="ttc" id="anamespacellvm_html_a398a9aa98927dce08c1aebcfdfedaa6f"><div class="ttname"><a href="namespacellvm.html#a398a9aa98927dce08c1aebcfdfedaa6f">llvm::PGOWarnMisExpect</a></div><div class="ttdeci">static cl::opt&lt; bool &gt; PGOWarnMisExpect(&quot;pgo-warn-misexpect&quot;, cl::init(false), cl::Hidden, cl::desc(&quot;Use this option to turn on/off &quot; &quot;warnings about incorrect usage of llvm.expect intrinsics.&quot;))</div></div>
<div class="ttc" id="aOptimizationRemarkEmitter_8h_html"><div class="ttname"><a href="OptimizationRemarkEmitter_8h.html">OptimizationRemarkEmitter.h</a></div></div>
<div class="ttc" id="anamespacellvm_1_1cl_html_a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6"><div class="ttname"><a href="namespacellvm_1_1cl.html#a68075925a54790e71ca790e1d4f21a40a263ac008d8d31f13ce460395fc4cf7e6">llvm::cl::Hidden</a></div><div class="ttdeci">@ Hidden</div><div class="ttdef"><b>Definition:</b> <a href="CommandLine_8h_source.html#l00138">CommandLine.h:138</a></div></div>
<div class="ttc" id="aMisExpect_8cpp_html_ad78e062f62e0d6e453941fb4ca843e4d"><div class="ttname"><a href="MisExpect_8cpp.html#ad78e062f62e0d6e453941fb4ca843e4d">DEBUG_TYPE</a></div><div class="ttdeci">#define DEBUG_TYPE</div><div class="ttdef"><b>Definition:</b> <a href="MisExpect_8cpp_source.html#l00048">MisExpect.cpp:48</a></div></div>
<div class="ttc" id="aclassllvm_1_1BranchProbability_html_a0333345669e75a54c7de3d5fe0f6e746"><div class="ttname"><a href="classllvm_1_1BranchProbability.html#a0333345669e75a54c7de3d5fe0f6e746">llvm::BranchProbability::getBranchProbability</a></div><div class="ttdeci">static BranchProbability getBranchProbability(uint64_t Numerator, uint64_t Denominator)</div><div class="ttdef"><b>Definition:</b> <a href="BranchProbability_8cpp_source.html#l00053">BranchProbability.cpp:53</a></div></div>
<div class="ttc" id="anamespacellvm_html_ab4d4bc901fedd8857f647dcc2c0d71de"><div class="ttname"><a href="namespacellvm.html#ab4d4bc901fedd8857f647dcc2c0d71de">llvm::max</a></div><div class="ttdeci">Expected&lt; ExpressionValue &gt; max(const ExpressionValue &amp;Lhs, const ExpressionValue &amp;Rhs)</div><div class="ttdef"><b>Definition:</b> <a href="FileCheck_8cpp_source.html#l00337">FileCheck.cpp:337</a></div></div>
<div class="ttc" id="anamespacellvm_1_1MipsISD_html_a422daf9aa810935178671306b651d69ba366e1eac31eeb1a1892d62ccfc0c8cf8"><div class="ttname"><a href="namespacellvm_1_1MipsISD.html#a422daf9aa810935178671306b651d69ba366e1eac31eeb1a1892d62ccfc0c8cf8">llvm::MipsISD::Ret</a></div><div class="ttdeci">@ Ret</div><div class="ttdef"><b>Definition:</b> <a href="MipsISelLowering_8h_source.html#l00119">MipsISelLowering.h:119</a></div></div>
<div class="ttc" id="aLowerExpectIntrinsic_8cpp_html_a6d8dd0fde9d96e02f04db1523ab644df"><div class="ttname"><a href="LowerExpectIntrinsic_8cpp.html#a6d8dd0fde9d96e02f04db1523ab644df">UnlikelyBranchWeight</a></div><div class="ttdeci">static cl::opt&lt; uint32_t &gt; UnlikelyBranchWeight(&quot;unlikely-branch-weight&quot;, cl::Hidden, cl::init(1), cl::desc(&quot;Weight of the branch unlikely to be taken (default = 1)&quot;))</div></div>
<div class="ttc" id="aIR_2Instruction_8h_html"><div class="ttname"><a href="IR_2Instruction_8h.html">Instruction.h</a></div></div>
<div class="ttc" id="aCommandLine_8h_html"><div class="ttname"><a href="CommandLine_8h.html">CommandLine.h</a></div></div>
<div class="ttc" id="anamespacellvm_html_a07eb6e84b522073e52d92dccf5015c01"><div class="ttname"><a href="namespacellvm.html#a07eb6e84b522073e52d92dccf5015c01">llvm::formatv</a></div><div class="ttdeci">auto formatv(const char *Fmt, Ts &amp;&amp;... Vals) -&gt; formatv_object&lt; decltype(std::make_tuple(detail::build_format_adapter(std::forward&lt; Ts &gt;(Vals))...))&gt;</div><div class="ttdef"><b>Definition:</b> <a href="FormatVariadic_8h_source.html#l00251">FormatVariadic.h:251</a></div></div>
<div class="ttc" id="aConstants_8h_html"><div class="ttname"><a href="Constants_8h.html">Constants.h</a></div></div>
<div class="ttc" id="aTwine_8h_html"><div class="ttname"><a href="Twine_8h.html">Twine.h</a></div></div>
<div class="ttc" id="aBuiltinGCs_8cpp_html_a7abf5fb4071cb25dbce06dfb5ee3c937"><div class="ttname"><a href="BuiltinGCs_8cpp.html#a7abf5fb4071cb25dbce06dfb5ee3c937">B</a></div><div class="ttdeci">static GCRegistry::Add&lt; OcamlGC &gt; B(&quot;ocaml&quot;, &quot;ocaml 3.10-compatible GC&quot;)</div></div>
<div class="ttc" id="aclassllvm_1_1Instruction_html"><div class="ttname"><a href="classllvm_1_1Instruction.html">llvm::Instruction</a></div><div class="ttdef"><b>Definition:</b> <a href="IR_2Instruction_8h_source.html#l00041">Instruction.h:41</a></div></div>
<div class="ttc" id="aclassllvm_1_1DiagnosticInfoMisExpect_html"><div class="ttname"><a href="classllvm_1_1DiagnosticInfoMisExpect.html">llvm::DiagnosticInfoMisExpect</a></div><div class="ttdoc">Diagnostic information for MisExpect analysis.</div><div class="ttdef"><b>Definition:</b> <a href="DiagnosticInfo_8h_source.html#l01036">DiagnosticInfo.h:1036</a></div></div>
<div class="ttc" id="aFormatVariadic_8h_html"><div class="ttname"><a href="FormatVariadic_8h.html">FormatVariadic.h</a></div></div>
<div class="ttc" id="aBranchProbability_8h_html"><div class="ttname"><a href="BranchProbability_8h.html">BranchProbability.h</a></div></div>
<div class="ttc" id="anamespacellvm_html_a0883663b1b2d8338f034f514cf8274d7"><div class="ttname"><a href="namespacellvm.html#a0883663b1b2d8338f034f514cf8274d7">llvm::MisExpectTolerance</a></div><div class="ttdeci">static cl::opt&lt; uint32_t &gt; MisExpectTolerance(&quot;misexpect-tolerance&quot;, cl::init(0), cl::desc(&quot;Prevents emiting diagnostics when profile counts are &quot; &quot;within N% of the threshold..&quot;))</div></div>
<div class="ttc" id="aADT_2tmp_8txt_html_a07ed0bfaa124c15897944fe3eaa971ab"><div class="ttname"><a href="ADT_2tmp_8txt.html#a07ed0bfaa124c15897944fe3eaa971ab">uint64_t</a></div><div class="ttdeci">Class for arbitrary precision integers APInt is a functional replacement for common case unsigned integer type like unsigned long or uint64_t</div><div class="ttdef"><b>Definition:</b> <a href="ADT_2tmp_8txt_source.html#l00001">tmp.txt:1</a></div></div>
<div class="ttc" id="aclassllvm_1_1cl_1_1opt_html"><div class="ttname"><a href="classllvm_1_1cl_1_1opt.html">llvm::cl::opt&lt; bool &gt;</a></div></div>
<div class="ttc" id="aclassllvm_1_1LLVMContext_html_afe71303f670173ad9ac988daddda59dc"><div class="ttname"><a href="classllvm_1_1LLVMContext.html#afe71303f670173ad9ac988daddda59dc">llvm::LLVMContext::getDiagnosticsMisExpectTolerance</a></div><div class="ttdeci">uint32_t getDiagnosticsMisExpectTolerance() const</div><div class="ttdef"><b>Definition:</b> <a href="LLVMContext_8cpp_source.html#l00159">LLVMContext.cpp:159</a></div></div>
<div class="ttc" id="aMisExpect_8h_html"><div class="ttname"><a href="MisExpect_8h.html">MisExpect.h</a></div></div>
<div class="ttc" id="aProfDataUtils_8h_html"><div class="ttname"><a href="ProfDataUtils_8h.html">ProfDataUtils.h</a></div></div>
<div class="ttc" id="aclassllvm_1_1LLVMContext_html"><div class="ttname"><a href="classllvm_1_1LLVMContext.html">llvm::LLVMContext</a></div><div class="ttdoc">This is an important class for using LLVM in a threaded context.</div><div class="ttdef"><b>Definition:</b> <a href="LLVMContext_8h_source.html#l00067">LLVMContext.h:67</a></div></div>
<div class="ttc" id="aMD5_8cpp_html_ac0eafdc9ee161b71e7af98af736952fd"><div class="ttname"><a href="MD5_8cpp.html#ac0eafdc9ee161b71e7af98af736952fd">I</a></div><div class="ttdeci">#define I(x, y, z)</div><div class="ttdef"><b>Definition:</b> <a href="MD5_8cpp_source.html#l00058">MD5.cpp:58</a></div></div>
<div class="ttc" id="anamespacellvm_1_1cl_html_a10a041239ae1870cfcc064bfaa79fb65"><div class="ttname"><a href="namespacellvm_1_1cl.html#a10a041239ae1870cfcc064bfaa79fb65">llvm::cl::init</a></div><div class="ttdeci">initializer&lt; Ty &gt; init(const Ty &amp;Val)</div><div class="ttdef"><b>Definition:</b> <a href="CommandLine_8h_source.html#l00445">CommandLine.h:445</a></div></div>
<div class="ttc" id="anamespacellvm_1_1misexpect_html_a4c52059f91406714507309d168ff95b8"><div class="ttname"><a href="namespacellvm_1_1misexpect.html#a4c52059f91406714507309d168ff95b8">llvm::misexpect::checkExpectAnnotations</a></div><div class="ttdeci">void checkExpectAnnotations(Instruction &amp;I, const ArrayRef&lt; uint32_t &gt; ExistingWeights, bool IsFrontend)</div><div class="ttdoc">checkExpectAnnotations - compares PGO counters to the thresholds used for llvm.expect and warns if th...</div><div class="ttdef"><b>Definition:</b> <a href="MisExpect_8cpp_source.html#l00202">MisExpect.cpp:202</a></div></div>
<div class="ttc" id="aSILowerControlFlow_8cpp_html_a4868c5d81c5ccc98c47aeab6244346a0"><div class="ttname"><a href="SILowerControlFlow_8cpp.html#a4868c5d81c5ccc98c47aeab6244346a0">assert</a></div><div class="ttdeci">assert(ImpDefSCC.getReg()==AMDGPU::SCC &amp;&amp;ImpDefSCC.isDef())</div></div>
<div class="ttc" id="aLowerExpectIntrinsic_8cpp_html_ad49597ea9df30b48ee0bae5eae846648"><div class="ttname"><a href="LowerExpectIntrinsic_8cpp.html#ad49597ea9df30b48ee0bae5eae846648">LikelyBranchWeight</a></div><div class="ttdeci">static cl::opt&lt; uint32_t &gt; LikelyBranchWeight(&quot;likely-branch-weight&quot;, cl::Hidden, cl::init(2000), cl::desc(&quot;Weight of the branch likely to be taken (default = 2000)&quot;))</div></div>
<div class="ttc" id="anamespacellvm_1_1misexpect_html_a62ecd68a608ec120263975c279ae3dab"><div class="ttname"><a href="namespacellvm_1_1misexpect.html#a62ecd68a608ec120263975c279ae3dab">llvm::misexpect::checkBackendInstrumentation</a></div><div class="ttdeci">void checkBackendInstrumentation(Instruction &amp;I, const llvm::ArrayRef&lt; uint32_t &gt; RealWeights)</div><div class="ttdoc">checkBackendInstrumentation - compares PGO counters to the thresholds used for llvm....</div><div class="ttdef"><b>Definition:</b> <a href="MisExpect_8cpp_source.html#l00186">MisExpect.cpp:186</a></div></div>
<div class="ttc" id="aclassllvm_1_1ArrayRef_html"><div class="ttname"><a href="classllvm_1_1ArrayRef.html">llvm::ArrayRef&lt; uint32_t &gt;</a></div></div>
<div class="ttc" id="aclassllvm_1_1OptimizationRemarkEmitter_html"><div class="ttname"><a href="classllvm_1_1OptimizationRemarkEmitter.html">llvm::OptimizationRemarkEmitter</a></div><div class="ttdoc">The optimization diagnostic interface.</div><div class="ttdef"><b>Definition:</b> <a href="OptimizationRemarkEmitter_8h_source.html#l00033">OptimizationRemarkEmitter.h:33</a></div></div>
<div class="ttc" id="aBasicBlockSections_8cpp_html_a5fd0741d696f28faf65b33f6c6af8fda"><div class="ttname"><a href="BasicBlockSections_8cpp.html#a5fd0741d696f28faf65b33f6c6af8fda">Cond</a></div><div class="ttdeci">SmallVector&lt; MachineOperand, 4 &gt; Cond</div><div class="ttdef"><b>Definition:</b> <a href="BasicBlockSections_8cpp_source.html#l00137">BasicBlockSections.cpp:137</a></div></div>
<div class="ttc" id="aclassuint32__t_html"><div class="ttname"><a href="classuint32__t.html">uint32_t</a></div></div>
<div class="ttc" id="alib_2Target_2ARM_2README_8txt_html_a1b45f45820a60c09244a87eb59824aec"><div class="ttname"><a href="lib_2Target_2ARM_2README_8txt.html#a1b45f45820a60c09244a87eb59824aec">S</a></div><div class="ttdeci">add sub stmia L5 ldr r0 bl L_printf $stub Instead of a and a wouldn t it be better to do three moves *Return an aggregate type is even return S</div><div class="ttdef"><b>Definition:</b> <a href="lib_2Target_2ARM_2README_8txt_source.html#l00210">README.txt:210</a></div></div>
<div class="ttc" id="anamespacellvm_1_1AMDGPU_1_1SendMsg_html_ad7fab8522e49be1b20c4db4fc431bd3c"><div class="ttname"><a href="namespacellvm_1_1AMDGPU_1_1SendMsg.html#ad7fab8522e49be1b20c4db4fc431bd3c">llvm::AMDGPU::SendMsg::Msg</a></div><div class="ttdeci">const CustomOperand&lt; const MCSubtargetInfo &amp; &gt; Msg[]</div><div class="ttdef"><b>Definition:</b> <a href="AMDGPUAsmUtils_8cpp_source.html#l00039">AMDGPUAsmUtils.cpp:39</a></div></div>
<div class="ttc" id="aclassllvm_1_1LLVMContext_html_aad03ef5cfbe6e7cad076d9e45ba06592"><div class="ttname"><a href="classllvm_1_1LLVMContext.html#aad03ef5cfbe6e7cad076d9e45ba06592">llvm::LLVMContext::diagnose</a></div><div class="ttdeci">void diagnose(const DiagnosticInfo &amp;DI)</div><div class="ttdoc">Report a message to the currently installed diagnostic handler.</div><div class="ttdef"><b>Definition:</b> <a href="LLVMContext_8cpp_source.html#l00248">LLVMContext.cpp:248</a></div></div>
<div class="ttc" id="aclassllvm_1_1Twine_html"><div class="ttname"><a href="classllvm_1_1Twine.html">llvm::Twine</a></div><div class="ttdoc">Twine - A lightweight data structure for efficiently representing the concatenation of temporary valu...</div><div class="ttdef"><b>Definition:</b> <a href="Twine_8h_source.html#l00081">Twine.h:81</a></div></div>
<div class="ttc" id="aclassllvm_1_1ArrayRef_html_aab36927882fbfdcbb860d87fd9c30da8"><div class="ttname"><a href="classllvm_1_1ArrayRef.html#aab36927882fbfdcbb860d87fd9c30da8">llvm::ArrayRef::begin</a></div><div class="ttdeci">iterator begin() const</div><div class="ttdef"><b>Definition:</b> <a href="ArrayRef_8h_source.html#l00151">ArrayRef.h:151</a></div></div>
<div class="ttc" id="anamespacellvm_1_1misexpect_html_a8677c5d2618fcf52eda43f5530decb6b"><div class="ttname"><a href="namespacellvm_1_1misexpect.html#a8677c5d2618fcf52eda43f5530decb6b">llvm::misexpect::verifyMisExpect</a></div><div class="ttdeci">void verifyMisExpect(Instruction &amp;I, ArrayRef&lt; uint32_t &gt; RealWeights, const ArrayRef&lt; uint32_t &gt; ExpectedWeights)</div><div class="ttdoc">veryifyMisExpect - compares RealWeights to the thresholds used for llvm.expect and warns if the PGO c...</div><div class="ttdef"><b>Definition:</b> <a href="MisExpect_8cpp_source.html#l00123">MisExpect.cpp:123</a></div></div>
<div class="ttc" id="aDiagnosticInfo_8h_html"><div class="ttname"><a href="DiagnosticInfo_8h.html">DiagnosticInfo.h</a></div></div>
<div class="ttc" id="aclassllvm_1_1OptimizationRemark_html"><div class="ttname"><a href="classllvm_1_1OptimizationRemark.html">llvm::OptimizationRemark</a></div><div class="ttdoc">Diagnostic information for applied optimization remarks.</div><div class="ttdef"><b>Definition:</b> <a href="DiagnosticInfo_8h_source.html#l00689">DiagnosticInfo.h:689</a></div></div>
<div class="ttc" id="aInstructions_8h_html"><div class="ttname"><a href="Instructions_8h.html">Instructions.h</a></div></div>
<div class="ttc" id="aclassllvm_1_1ArrayRef_html_a85ffb6531d4cda988ea81f18d4e56fb7"><div class="ttname"><a href="classllvm_1_1ArrayRef.html#a85ffb6531d4cda988ea81f18d4e56fb7">llvm::ArrayRef::size</a></div><div class="ttdeci">size_t size() const</div><div class="ttdoc">size - Get the array size.</div><div class="ttdef"><b>Definition:</b> <a href="ArrayRef_8h_source.html#l00163">ArrayRef.h:163</a></div></div>
<div class="ttc" id="anamespacellvm_html_ac19cbbc4935a23e1d44f65e1eaba6b1d"><div class="ttname"><a href="namespacellvm.html#ac19cbbc4935a23e1d44f65e1eaba6b1d">llvm::extractBranchWeights</a></div><div class="ttdeci">bool extractBranchWeights(const MDNode *ProfileData, SmallVectorImpl&lt; uint32_t &gt; &amp;Weights)</div><div class="ttdoc">Extract branch weights from MD_prof metadata.</div><div class="ttdef"><b>Definition:</b> <a href="ProfDataUtils_8cpp_source.html#l00122">ProfDataUtils.cpp:122</a></div></div>
<div class="ttc" id="aLLVMContext_8h_html"><div class="ttname"><a href="LLVMContext_8h.html">LLVMContext.h</a></div></div>
<div class="ttc" id="astructllvm_1_1cl_1_1desc_html"><div class="ttname"><a href="structllvm_1_1cl_1_1desc.html">llvm::cl::desc</a></div><div class="ttdef"><b>Definition:</b> <a href="CommandLine_8h_source.html#l00411">CommandLine.h:411</a></div></div>
<div class="ttc" id="aDebug_8h_html"><div class="ttname"><a href="Debug_8h.html">Debug.h</a></div></div>
<div class="ttc" id="aclassllvm_1_1ArrayRef_html_a7ca5197533a9c1fb8a2bd30587fcec6b"><div class="ttname"><a href="classllvm_1_1ArrayRef.html#a7ca5197533a9c1fb8a2bd30587fcec6b">llvm::ArrayRef::end</a></div><div class="ttdeci">iterator end() const</div><div class="ttdef"><b>Definition:</b> <a href="ArrayRef_8h_source.html#l00152">ArrayRef.h:152</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Mon Aug 7 2023 10:36:13 for LLVM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
